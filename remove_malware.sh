#!/bin/sh
echo "Scanning range $1"
$(which nmap) -p 22 -oG ssh.txt $1 >/dev/null; # scan range for opened SSH

if [ -f ssh.txt ]; then
	cat ssh.txt | cut -d " "  -f2 | grep -v [^0-9.] | sort -n | uniq > ssh_list.txt; rm ssh.txt; # filter results
fi

echo "Found $(wc -l ssh_list.txt | cut -d " " -f1) hosts with active SSH"

if [ -f infected_list.txt ]; then
	rm infected_list.txt >/dev/null 2>&1; # clear infected file list
fi
while read ip; do printf "$ip\r"; sshpass -p fucker ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o ConnectTimeout=2 mother@$ip 'exit' 2>/dev/null </dev/null && echo "Infected host $ip" && echo "$ip" >> infected_list.txt; done < ssh_list.txt # try to connect to all opened SSH with user:pass mother:fucker

if [ -f ssh.txt ]; then
	rm ssh_list.txt
fi

if [ -f infected_list.txt ]; then
	echo "Found $(wc -l infected_list.txt | cut -d " " -f1) infected hosts"
	echo "Curing..."
	while read ip; do ./malware.exp $ip </dev/null; done <infected_list.txt # call CureMalware.jar to that ip
fi
